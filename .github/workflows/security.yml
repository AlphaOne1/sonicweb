# Copyright the SonicWeb contributors.
# SPDX-License-Identifier: MPL-2.0

name: Security

on:
    push:
        branches:
            - master
    pull_request:
        branches:
            - master

# Declare default permissions as read-only.
permissions: read-all

jobs:
    GolangCI:
        runs-on: ubuntu-latest
        permissions:
            # read action required for private repository
            actions: read
            contents: read
            security-events: write
        steps:
          - name: Harden Runner
            uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
            with:
                egress-policy: audit

          - name: Checkout
            uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
            with:
                fetch-depth: 1

          - name: Run golangci-lint
            uses: golangci/golangci-lint-action@4afd733a84b1f43292c63897423277bb7f4313a9 # v8.0.0
            with:
                version: latest
                args: --timeout=5m --output.sarif.path=golangci-lint-results.sarif

    TrivyCode:
        runs-on: ubuntu-latest
        permissions:
            # read action required for private repository
            actions: read
            contents: read
            security-events: write
        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
              with:
                  egress-policy: audit

            - name: Checkout code
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

            - name: Run Trivy vulnerability scanner in repo mode
              uses: aquasecurity/trivy-action@76071ef0d7ec797419534a183b498b4d6366cf37 # 0.31.0
              with:
                  scan-type: 'fs'
                  ignore-unfixed: true
                  format: 'sarif'
                  output: 'trivy-results.sarif'
                  severity: 'CRITICAL'

# Disabled as long as not public
#            - name: Upload Trivy scan results to GitHub Security tab
#              uses: github/codeql-action/upload-sarif@ce28f5bb42b7a9f2c824e633a3f6ee835bab6858 # v3.29.0
#              with:
#                  sarif_file: 'trivy-results.sarif'

    VulnerabilityCheck:
        strategy:
            matrix:
                go-version:
                  - "stable"
        runs-on: ubuntu-latest
        permissions:
            # read action required for private repository
            actions: read
            contents: read
            security-events: write
        steps:
          - name: Harden Runner
            uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
            with:
                egress-policy: audit

          - name: Checkout
            uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
            with:
                fetch-depth: 1

          - name: Vulnerability Check
            uses: golang/govulncheck-action@b625fbe08f3bccbe446d94fbf87fcc875a4f50ee # v1.0.4
            with:
                go-version-input: ${{matrix.go-version}}
                output-format: sarif
                output-file: govulncheck-results.sarif

          - name: Print Sarif
            id: printSarif
            run:  |
                cat govulncheck-results.sarif
                if grep results govulncheck-results.sarif
                then
                    echo "hasResults=true" >> $GITHUB_OUTPUT
                else
                    echo "hasResults=false" >> $GITHUB_OUTPUT
                fi

# Disabled as long as not public
#          - name: Upload govulncheck results to Security tab
#            if: ${{ steps.printSarif.outputs.hasResults == 'true' }}
#            uses: github/codeql-action/upload-sarif@b6a472f63d85b9c78a3ac5e89422239fc15e9b3c # v3.28.1
#            with:
#                sarif_file: govulncheck-results.sarif
