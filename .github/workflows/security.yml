# Copyright the SonicWeb contributors.
# SPDX-License-Identifier: MPL-2.0

name: Security

on:
    push:
        branches:
            - master
    pull_request:
        branches:
            - master

# Declare default permissions as read only.
permissions:
    #only need as long as private
    actions: read
    contents: read
    security-events: write

jobs:
#    TrivyCode:
#        runs-on: ubuntu-latest
#        permissions:
#            contents: read
#            security-events: write
#        steps:
#          - name: Harden Runner
#            uses: step-security/harden-runner@c95a14d0e5bab51a9f56296a4eb0e416910cd350 # v2.10.3
#            with:
#                egress-policy: audit
#
#          - name: Checkout Code
#            uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
#
#          - name: Trivy Vulnerability Scan Repo Mode
#            uses: aquasecurity/trivy-action@6e7b7d1fd3e4fef0c5fa8cce1229c54b2c9bd0d8 # 0.24.0
#            with:
#                scan-type: 'fs'
#                ignore-unfixed: true
#                format: 'sarif'
#                output: 'trivy-results.sarif'
#                severity: 'CRITICAL'
#
#          - name: Print Sarif
#            id: printSarif
#            run:  |
#                cat trivy-results.sarif
#                if grep results trivy-results.sarif
#                then
#                    echo "hasResults=true" >> $GITHUB_OUTPUT
#                else
#                    echo "hasResults=false" >> $GITHUB_OUTPUT
#                fi
#
#          - name: Upload Trivy Results to Security Tab
#            if: ${{ steps.printSarif.outputs.hasResults == 'true' }}
#            uses: github/codeql-action/upload-sarif@b6a472f63d85b9c78a3ac5e89422239fc15e9b3c # v3.28.1
#            with:
#                sarif_file: 'trivy-results.sarif'

    VulnerabilityCheck:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write
        steps:
          - name: Harden Runner
            uses: step-security/harden-runner@c95a14d0e5bab51a9f56296a4eb0e416910cd350 # v2.10.3
            with:
                egress-policy: audit

          - name: Checkout
            uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
            with:
                fetch-depth: 1

          - name: Vulnerability Check
            uses: golang/govulncheck-action@b625fbe08f3bccbe446d94fbf87fcc875a4f50ee # v1.0.4
            with:
                output-format: sarif
                output-file: govulncheck-results.sarif

          - name: Print Sarif
            id: printSarif
            run:  |
                cat govulncheck-results.sarif
                if grep results govulncheck-results.sarif
                then
                    echo "hasResults=true" >> $GITHUB_OUTPUT
                else
                    echo "hasResults=false" >> $GITHUB_OUTPUT
                fi

          - name: Upload govulncheck Results to Security Tab
            if: ${{ steps.printSarif.outputs.hasResults == 'true' }}
            uses: github/codeql-action/upload-sarif@b6a472f63d85b9c78a3ac5e89422239fc15e9b3c # v3.28.1
            with:
                sarif_file: govulncheck-results.sarif
