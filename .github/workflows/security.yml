# Copyright the SonicWeb contributors.
# SPDX-License-Identifier: MPL-2.0

name: Security

on:
    push:
        branches:
            - master
    pull_request:
        branches:
            - master

# Declare default permissions as read only
permissions: read-all

jobs:
    TrivyCode:
        runs-on: ubuntu-latest
        permissions:
            security-events: write
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4.2.0

            - name: Trivy Vulnerability Scan Repo Mode
              uses: aquasecurity/trivy-action@v0.24.0
              with:
                  scan-type: fs
                  ignore-unfixed: true
                  format: sarif
                  output: trivy-results.sarif
                  severity: CRITICAL

            - name: Upload Scan Results to Security Tab
              uses: github/codeql-action/upload-sarif@v3.26.11
              with:
                  sarif-file: trivy-results.sarif

    VulnerabilityCheck:
        runs-on: ubuntu-latest
        permissions:
            security-events: write
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4.2.0
              with:
                  fetch-depth: '1'

            - name: Vulnerability Check
              uses: golang/govulncheck-action@v1.0.4
              with:
                  go-version-input: "1.23"
                  output-format: sarif
                  output-file: govulncheck-results.sarif

            - name: Print Sarif
              run: |
                  cat govulncheck-results.sarif
                  if [ grep results govulncheck-results.sarif ]
                  then
                      echo "hasResults=true"  >> $GITHUB_OUTPUT
                  else
                      echo "hasResults=false" >> $GITHUB_OUTPUT
                  fi
            - name: Upload govulncheck Results to Security Tab
              if: ${{ steps.PrintSarif.outputs.hasResults == 'true' }}
              uses: github/codeql-action/upload-sarif@v3.26.11
              with:
                  sarif-file: govulncheck-results.sarif
