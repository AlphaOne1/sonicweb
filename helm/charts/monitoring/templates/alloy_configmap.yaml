{{- /*
SPDX-FileCopyrightText: 2026 The SonicWeb contributors.
SPDX-License-Identifier: MPL-2.0
*/ -}}

apiVersion: v1
kind: ConfigMap
metadata:
    name: alloy-collector-config
data:
    config: |
        // OTLP receiver for metrics, logs and traces
        otelcol.receiver.otlp "default" {
            grpc { endpoint = "0.0.0.0:4317" }
            http { endpoint = "0.0.0.0:4318" }
            output {
                metrics = [otelcol.exporter.prometheus.vmetrics.input]
                logs    = [otelcol.exporter.otlp.vlogs.input]
                traces  = [otelcol.exporter.otlp.vtraces.input]
            }
        }

        // forwarding to VictoriaMetrics
        otelcol.exporter.prometheus "vmetrics" {
            forward_to = [prometheus.remote_write.vmetrics.receiver]
        }

        prometheus.remote_write "vmetrics" {
            endpoint {
                url = "http://{{ include "monitoring.fullname" . }}-metrics-server:8428/api/v1/write"
            }
        }

        // forwarding to VictoriaLogs via OTLP
        otelcol.exporter.otlp "vlogs" {
            client {
                endpoint = "{{ include "monitoring.fullname" . }}-logs-server:9428"
                tls { insecure = true }
            }
        }

        // forwarding to VictoriaTraces via OTLP
        otelcol.exporter.otlp "vtraces" {
            client {
                endpoint = "{{ include "monitoring.fullname" . }}-traces-server:10428"
                tls { insecure = true }
            }
        }
