# SPDX-FileCopyrightText: 2026 The SonicWeb contributors.
# SPDX-License-Identifier: MPL-2.0

grafana:
    fullnameOverride: "monitoring-grafana"
    # add plugin installation
    plugins:
        - victoriametrics-logs-datasource
    sidecar:
        datasources:
            enabled:         true
            label:           grafana_datasource
            searchNamespace: ALL
    additionalDataSources:
        -   name:      VictoriaMetrics
            type:      prometheus
            url:       http://monitoring-metrics-server:8428
            access:    proxy
            isDefault: true
        -   name:   VictoriaLogs
            type:   victoriametrics-logs-datasource # official plugin type
            url:    http://monitoring-logs-server:9428
            access: proxy
        -   name:   VictoriaTraces
            type:   jaeger
            url:    http://monitoring-vt-single-server:10428
            access: proxy

alloy:
    fullnameOverride: "monitoring-alloy"
    alloy:
        # opens the OTLP ports on the kubernetes service
        extraPorts:
            -   name:       otlp-grpc
                port:       4317
                targetPort: 4317
                protocol:   TCP
            -   name:       otlp-http
                port:       4318
                targetPort: 4318
                protocol:   TCP
        configMap:
            create:  true
            content: |
                     // OTLP receiver for metrics, logs and traces
                     otelcol.receiver.otlp "default" {
                       grpc { endpoint = "0.0.0.0:4317" }
                       http { endpoint = "0.0.0.0:4318" }
                       output {
                         metrics = [otelcol.exporter.prometheus.vmetrics.input]
                         logs    = [otelcol.exporter.otlp.vlogs.input]
                         traces  = [otelcol.exporter.otlp.vtraces.input]
                       }
                     }
                     
                     // forwarding to VictoriaMetrics
                     otelcol.exporter.prometheus "vmetrics" {
                       forward_to = [prometheus.remote_write.vmetrics.receiver]
                     }
                     prometheus.remote_write "vmetrics" {
                       endpoint {
                         url = "http://monitoring-metrics-server:8428/api/v1/write"
                       }
                     }
                     
                     // forwarding to VictoriaLogs via OTLP
                     otelcol.exporter.otlp "vlogs" {
                       client {
                         endpoint = "monitoring-logs-server:9428"
                         tls { insecure = true }
                       }
                     }
                     
                     // forwarding to VictoriaTraces via OTLP
                     otelcol.exporter.otlp "vtraces" {
                       client {
                         endpoint = "monitoring-vt-single-server:10428"
                         tls { insecure = true }
                       }
                     }

metrics:
    fullnameOverride: "monitoring-metrics"
    server:
        persistentVolume:
            enabled: false
        extraArgs:
            retentionPeriod: 24h

logs:
    fullnameOverride: "monitoring-logs"
    server:
        persistentVolume:
            enabled: false
        retentionPeriod: 1h

traces:
    fullnameOverride: "monitoring-vt-single" # must fit to the service namen in the subchart
    server:
        persistentVolume:
            enabled: false
        retentionPeriod: 1h
