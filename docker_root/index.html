<!-- SPDX-FileCopyrightText: 2025 The SonicWeb contributors.
     SPDX-License-Identifier: MPL-2.0
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Markdown Viewer</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="referrer" content="same-origin">

    <style>
        body {
            background-color: #f6f8fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            margin: 0;
            align-items: flex-start;
            padding: max(1rem, env(safe-area-inset-top)) 1rem 1rem 1rem;
        }

        .markdown-body {
            box-sizing: border-box;
            min-width: 200px;
            max-width: 90ch;
            width: clamp(200px, 90vw, 90ch);
            padding: 2rem;
            line-height: 1.6;
            overflow-wrap: anywhere;
            content-visibility: auto;
            contain-intrinsic-size: 1200px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        .visually-hidden {
            position: absolute !important;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0 0 0 0);
            white-space: nowrap;
            border: 0;
        }
    </style>

    <!-- Load GitHub Markdown CSS: local first, fallback to CDN -->
    <script>
        // Generation of SRI-Hash:
        //     curl -sSL <URL> | openssl dgst -sha256 -binary | openssl base64 -A
        // and remove trailing % if present.
        function loadCSS(localHref, fallbackHref, fallbackInt) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = localHref;
            link.onerror = () => {
                console.warn(`CSS failed: ${localHref}, loading fallback...`);
                const fallbackLink = document.createElement('link');
                fallbackLink.rel = 'stylesheet';
                fallbackLink.href = fallbackHref;

                if (fallbackInt) {
                    fallbackLink.integrity = fallbackInt;
                    fallbackLink.crossOrigin = 'anonymous';
                }

                document.head.appendChild(fallbackLink);
            };
            document.head.appendChild(link);
        }

        function loadScript(scripts, callback) {
            const script = document.createElement('script');

            if (scripts.length === 0) {
                if (callback) callback();
                return;
            }

            const localSrc    = scripts[0][0]
            const fallbackSrc = scripts[0][1]
            const fallbackInt = scripts[0][2]

            script.src = localSrc;
            script.onload = () => {
                console.log(`Loaded: ${localSrc}`);
                loadScript(scripts.slice(1), callback);
            };
            script.onerror = () => {
                console.warn(`Script failed: ${localSrc}, loading fallback...`);
                const fallbackScript = document.createElement('script');
                fallbackScript.src = fallbackSrc;

                if (fallbackInt) {
                    fallbackScript.crossOrigin = "anonymous";
                    fallbackScript.integrity = fallbackInt;
                }

                fallbackScript.onload = () => {
                    console.log(`Loaded fallback: ${fallbackSrc}`);
                    loadScript(scripts.slice(1), callback);
                };
                fallbackScript.onerror = () => {
                    console.error(`Fallback load failed: ${fallbackSrc}`);
                };
                document.head.appendChild(fallbackScript);
            };
            document.head.appendChild(script);
        }

        function renderMarkdownFromFile(filePath, elementID) {
            fetch(filePath, { cache: 'no-cache' })
                .then(res => {
                    if (!res.ok) throw new Error(`${filePath} not found (${res.status})`);
                    return res.text();
                })
                .then(md => {
                    if (typeof marked !== 'undefined') {
                        // no DOMPurify, as we control the content of the Markdown here
                        document.getElementById(elementID).innerHTML = marked.parse(md);
                    } else {
                        document.getElementById(elementID).innerHTML = "<p><strong>Error:</strong> Markdown parser not available.</p>";
                    }
                })
                .catch(err => {
                    document.getElementById(elementID).innerHTML = `<p><strong>Error:</strong> ${err.message}</p>`;
                    console.error(err);
                });
        }

        loadCSS(
            'css/github-markdown.min.css',
            'https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.8.1/github-markdown.min.css',
            'sha384-bKf/D9oOhMXM113OMRKT6sKFRT4jT3AulvzsGu563IJ5zmaH5LSA26VfwRJQ8GAR'
        );

        // highlight.js theme CSS
        loadCSS(
            'css/github.min.css',
            'https://cdn.jsdelivr.net/npm/highlight.js@11.11.1/styles/github.min.css',
            'sha384-eFTL69TLRZTkNfYZOLM+G04821K1qZao/4QLJbet1pP4tcF+fdXq/9CdqAbWRl/L'
        );
    </script>
</head>
<body>

<main id="content" class="markdown-body" aria-live="polite" aria-busy="true">
    <h1 class="visually-hidden"> SonicWeb Documentation </h1>
    <p><em> README.md is loading... </em></p>
</main>
<noscript>
    <p><strong> Note: </strong> JavaScript is required to render the Markdown content.
       Please enable JavaScript or view the raw README.md instead.
    </p>
</noscript>
<script defer>
    document.addEventListener('DOMContentLoaded', () => {
        let loaded = false;

        // 1) Load highlight.js first (local â†’ CDN)
        loadScript(
            [
                [   'js/highlight.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js',
                    'sha384-RH2xi4eIQ/gjtbs9fUXM68sLSi99C7ZWBRX1vDrVv6GQXRibxXLbwO2NGZB74MbU'
                ],
                [   'js/marked.umd.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/marked/16.3.0/lib/marked.umd.min.js',
                    'sha384-28tGVU6cfNCYHN01DPkRbQ5zNcqr7cHx7RE2PA0Os8oQsE0H1dRIJBoGPX75oXDs'
                ]
            ],
            () => {
                if (loaded) {
                    return;
                }
                loaded = true;

                // 3) Configure marked highlighting only after both are available
                if (typeof marked !== 'undefined' && typeof hljs !== 'undefined') {
                    marked.setOptions({
                        highlight: (code, lang) => {
                            if (lang && hljs.getLanguage(lang)) {
                                return hljs.highlight(code, { language: lang }).value;
                            }
                            return hljs.highlightAuto(code).value;
                        }
                    });
                } else {
                    console.warn('highlight.js or marked not available; code blocks will not be highlighted.');
                }

                // 4) Render once everything is ready
                renderMarkdownFromFile('README.md', 'content');
                const content = document.getElementById('content');
                if (content) {
                    content.setAttribute('aria-busy', 'false');
                }
            }
        );
    });
</script>
</body>
</html>
